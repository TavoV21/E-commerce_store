pipeline{
    agent any

    tools{
        nodejs "node"
    }

    environment{
        GMAIL_CREDS = credentials('NODEMAILER_AUTH')
    }
    
    stages{
       
        stage('docker login'){
            steps{

               /*  withCredentials([usernamePassword(credentialsId: 'DOCKER_CREDENTIALS', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]){
                    sh ''' 
                        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
                    '''
                }  
 */
                 withCredentials([usernamePassword(credentialsId: 'DOCKER_GUEST_AUTH', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]){
                    sh ''' 
                        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
                    '''
                }        
                
            }

            post {
                success {
                    echo "✅ te loggeaste OMG"
                }
                failure {
                    echo "❌ algo anda mal"
                }
            }
        }

        stage('test'){
            steps{
                sh 'docker info'
                sh '''
                echo "NODE_ENV=test" > backend/.env.test
                echo "POSTGRES_DB=shopping_test" >> backend/.env.test
                echo "POSTGRES_HOST=testdb_pg" >> backend/.env.test
                echo "POSTGRES_USER=tavo" >> backend/.env.test
                echo "POSTGRES_PASSWORD=1234" >> backend/.env.test
                echo "POSTGRES_PORT=5432" >> backend/.env.test
                echo "SECRET=mySecretKey" >> backend/.env.test
                echo "ADMIN_EMAIL=admin@gmail.com" >> backend/.env.test
                echo "ADMIN_PASSWORD=1111" >> backend/.env.test
                echo "EMAIL=GMAIL_CREDS_USR" >> backend/.env.test
                echo "PASS_EMAIL=GMAIL_CREDS_PSW" >> backend/.env.test
                
                docker compose -f docker-compose.test.yml up
                docker compose -f docker-compose.test.yml down -v
                 '''
              
            
            }


        }

        
       
    }
}